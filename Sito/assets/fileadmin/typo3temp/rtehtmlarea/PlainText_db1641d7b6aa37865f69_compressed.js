HTMLArea.PlainText=HTMLArea.Plugin.extend({constructor:function(editor,pluginName){this.base(editor,pluginName);},configurePlugin:function(editor){this.buttonsConfiguration=this.editorConfiguration.buttons;var pluginInformation={version:'1.0',developer:'Stanislas Rolland',developerUrl:'http://www.sjbr.ca/',copyrightOwner:'Stanislas Rolland',sponsor:'Otto van Bruggen',sponsorUrl:'http://www.webspinnerij.nl',license:'GPL'};this.registerPluginInformation(pluginInformation);Ext.iterate(this.buttonList,function(buttonId,buttonConf){var buttonConfiguration={id:buttonId,tooltip:this.localize(buttonId+'Tooltip'),iconCls:'htmlarea-action-'+buttonConf[1],action:'onButtonPress',dialog:buttonConf[2]};this.registerButton(buttonConfiguration);},this);return true;},buttonList:{PasteToggle:['pastetoggle','paste-toggle',false],PasteBehaviour:['pastebehaviour','paste-behaviour',true]},cleanerConfig:{pasteStructure:{keepTags:/^(a|p|h[0-6]|pre|address|blockquote|div|hr|br|table|thead|tbody|tfoot|caption|tr|th|td|ul|ol|dl|li|dt|dd)$/i,removeAttributes:/^(id|on*|style|class|className|lang|align|valign|bgcolor|color|border|face|.*:.*)$/i},pasteFormat:{keepTags:/^(a|p|h[0-6]|pre|address|blockquote|div|hr|br|table|thead|tbody|tfoot|caption|tr|th|td|ul|ol|dl|li|dt|dd|b|bdo|big|cite|code|del|dfn|em|i|ins|kbd|label|q|samp|small|strike|strong|sub|sup|tt|u|var)$/i,removeAttributes:/^(id|on*|style|class|className|lang|align|valign|bgcolor|color|border|face|.*:.*)$/i}},onGenerate:function(){if(this.buttonsConfiguration&&this.buttonsConfiguration['pastebehaviour']){this.pasteBehaviourConfiguration=this.buttonsConfiguration['pastebehaviour'];}
this.cleaners={};Ext.iterate(this.cleanerConfig,function(behaviour){if(this.pasteBehaviourConfiguration&&this.pasteBehaviourConfiguration[behaviour]){if(this.pasteBehaviourConfiguration[behaviour].keepTags){this.cleanerConfig[behaviour].keepTags=new RegExp('^('+this.pasteBehaviourConfiguration[behaviour].keepTags.split(',').join('|')+')$','i');}
if(this.pasteBehaviourConfiguration[behaviour].removeAttributes){this.cleanerConfig[behaviour].removeAttributes=new RegExp('^('+this.pasteBehaviourConfiguration[behaviour].removeAttributes.split(',').join('|')+')$','i');}}
this.cleaners[behaviour]=new HTMLArea.DOM.Walker(this.cleanerConfig[behaviour]);},this);this.currentBehaviour='plainText';if(this.buttonsConfiguration&&this.buttonsConfiguration['pastebehaviour']&&this.buttonsConfiguration['pastebehaviour']['current']){this.currentBehaviour=this.buttonsConfiguration['pastebehaviour']['current'];}
this.editor.iframe.mon(Ext.get(Ext.isIE?this.editor.document.body:this.editor.document.documentElement),'paste',this.onPaste,this);},toggleButton:function(buttonId){var button=this.getButton(buttonId);button.setInactive(!button.inactive);},onButtonPress:function(editor,id,target){var buttonId=this.translateHotKey(id);buttonId=buttonId?buttonId:id;switch(buttonId){case'PasteBehaviour':this.openDialogue(buttonId,'PasteBehaviourTooltip',this.getWindowDimensions({width:260,height:260},buttonId));break;case'PasteToggle':this.toggleButton(buttonId);this.editor.focus();break;}
return false;},openDialogue:function(buttonId,title,dimensions){this.dialog=new Ext.Window({title:this.localize(title),cls:'htmlarea-window',border:false,width:dimensions.width,height:'auto',resizable:!Ext.isIE,iconCls:this.getButton(buttonId).iconCls,listeners:{close:{fn:this.onClose,scope:this}},items:[{xtype:'fieldset',defaultType:'radio',title:this.getHelpTip('behaviour',title),labelWidth:170,defaults:{labelSeparator:'',name:buttonId},items:[{itemId:'plainText',fieldLabel:this.getHelpTip('plainText','plainText'),checked:(this.currentBehaviour==='plainText')},{itemId:'pasteStructure',fieldLabel:this.getHelpTip('pasteStructure','pasteStructure'),checked:(this.currentBehaviour==='pasteStructure')},{itemId:'pasteFormat',fieldLabel:this.getHelpTip('pasteFormat','pasteFormat'),checked:(this.currentBehaviour==='pasteFormat')}]}],buttons:[this.buildButtonConfig('OK',this.onOK)]});this.show();},onOK:function(){var fields=['plainText','pasteStructure','pasteFormat'];Ext.each(fields,function(field){if(this.dialog.find('itemId',field)[0].getValue()){this.currentBehaviour=field;return false;}},this);this.close();return false;},onPaste:function(event){if(!this.getButton('PasteToggle').inactive){switch(this.currentBehaviour){case'plainText':if(Ext.isIE||Ext.isWebKit){var clipboardText=this.grabClipboardText(event);if(clipboardText){this.editor.insertHTML(clipboardText);}
return!this.clipboardText;}
case'pasteStructure':case'pasteFormat':if(Ext.isIE){this.editor.focus();this.bookmark=this.editor.getBookmark(this.editor._createRange(this.editor._getSelection()));this.openPastingPad('PasteToggle',this.currentBehaviour,this.getWindowDimensions({width:550,height:550},'PasteToggle'));event.browserEvent.returnValue=false;return false;}else{this.redirectPaste();this.processPastedContent.defer(Ext.isWebKit?500:50,this);}
break;default:break;}}
return true;},grabClipboardText:function(event){var clipboardText='';if(window.clipboardData||event.browserEvent.clipboardData||event.browserEvent.dataTransfer){clipboardText=(window.clipboardData||event.browserEvent.clipboardData||event.browserEvent.dataTransfer).getData('text');}
if(clipboardText){event.stopEvent();}else{TYPO3.Dialog.InformationDialog({title:this.localize('Paste-as-Plain-Text'),msg:this.localize('Access-to-clipboard-denied')});}
return clipboardText;},redirectPaste:function(){this.editor.focus();this.bookmark=this.editor.getBookmark(this.editor._createRange(this.editor._getSelection()));var hiddenSection=this.editor.document.createElement('div');HTMLArea.DOM.addClass(hiddenSection,'htmlarea-paste-hidden-section');hiddenSection.setAttribute('style','position: absolute; left: -10000px; top: '+this.editor.document.body.scrollTop+'px; overflow: hidden;');hiddenSection=this.editor.document.body.appendChild(hiddenSection);if(Ext.isWebKit){hiddenSection.innerHTML='&nbsp;';}
this.editor.selectNodeContents(hiddenSection);},processPastedContent:function(){this.editor.focus();var divs=this.editor.document.getElementsByClassName('htmlarea-paste-hidden-section');var hiddenSection=divs[0];for(var i=divs.length;--i>=1;){HTMLArea.removeFromParent(divs[i]);}
var content='';switch(this.currentBehaviour){case'plainText':content=hiddenSection.textContent;break;case'pasteStructure':case'pasteFormat':content=this.cleaners[this.currentBehaviour].render(hiddenSection,false);break;}
HTMLArea.removeFromParent(hiddenSection);this.editor.selectRange(this.editor.moveToBookmark(this.bookmark));if(content){this.editor.execCommand('insertHTML',false,content);}},openPastingPad:function(buttonId,title,dimensions){this.dialog=new Ext.Window({title:this.getHelpTip(title,title),cls:'htmlarea-window',bodyCssClass:'pasting-pad',border:false,width:dimensions.width,height:'auto',resizable:!Ext.isIE,iconCls:this.getButton(buttonId).iconCls,listeners:{afterrender:{fn:function(event){this.onPastingPadAfterRender.defer(100,this,[event]);},scope:this},close:{fn:this.onClose,scope:this}},items:[{xtype:'tbtext',text:this.getHelpTip('pasteInPastingPad','pasteInPastingPad'),style:{marginBottom:'5px'}},{xtype:'box',itemId:'pasting-pad-iframe',autoEl:{name:'contentframe',tag:'iframe',cls:'contentframe',src:Ext.isGecko?'javascript:void(0);':HTMLArea.editorUrl+'popups/blank.html'}}],buttons:[this.buildButtonConfig('OK',this.onPastingPadOK),this.buildButtonConfig('Cancel',this.onCancel)]});this.show();},onPastingPadAfterRender:function(){var iframe=this.dialog.getComponent('pasting-pad-iframe').getEl().dom;var pastingPadDocument=iframe.contentWindow?iframe.contentWindow.document:iframe.contentDocument;this.pastingPadBody=pastingPadDocument.body;this.pastingPadBody.contentEditable=true;this.dialog.mon(Ext.get(this.pastingPadBody),'paste',this.onPastingPadPaste,this);this.pastingPadBody.focus();},onPastingPadPaste:function(event){this.cleanPastingPadContents.defer(50,this);},cleanPastingPadContents:function(){this.pastingPadBody.innerHTML=this.cleaners[this.currentBehaviour].render(this.pastingPadBody,false);this.pastingPadBody.focus();},onPastingPadOK:function(){this.editor.focus();this.restoreSelection();this.editor.insertHTML(this.pastingPadBody.innerHTML);this.close();return false;},onUpdateToolbar:function(button,mode,selectionEmpty,ancestors){if(mode==='wysiwyg'&&this.editor.isEditable()){switch(button.itemId){case'PasteToggle':button.setTooltip({title:this.localize((button.inactive?'enable':'disable')+this.currentBehaviour)});break;}}}});