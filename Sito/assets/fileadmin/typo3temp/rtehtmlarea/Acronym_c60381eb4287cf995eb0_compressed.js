HTMLArea.Acronym=HTMLArea.Plugin.extend({constructor:function(editor,pluginName){this.base(editor,pluginName);},configurePlugin:function(editor){this.pageTSConfiguration=this.editorConfiguration.buttons.acronym;var pluginInformation={version:'2.3',developer:'Stanislas Rolland',developerUrl:'http://www.sjbr.ca/',copyrightOwner:'Stanislas Rolland',sponsor:'SJBR',sponsorUrl:'http://www.sjbr.ca/',license:'GPL'};this.registerPluginInformation(pluginInformation);var buttonId='Acronym';var buttonConfiguration={id:buttonId,tooltip:this.localize('Insert/Modify Acronym'),action:'onButtonPress',hide:(this.pageTSConfiguration.noAcronym&&this.pageTSConfiguration.noAbbr),dialog:true,iconCls:'htmlarea-action-abbreviation-edit',contextMenuTitle:this.localize(buttonId+'-contextMenuTitle')};this.registerButton(buttonConfiguration);return true;},configDefaults:{combo:{editable:true,selectOnFocus:true,typeAhead:true,triggerAction:'all',forceSelection:true,mode:'local'}},onButtonPress:function(editor,id){var buttonId=this.translateHotKey(id);buttonId=buttonId?buttonId:id;var selection=editor._getSelection();var abbr=editor._activeElement(selection);if(!abbr&&this.editor.statusBar&&this.editor.statusBar.getSelection()){abbr=this.editor.statusBar.getSelection();}
if(!abbr||!/^(acronym|abbr)$/i.test(abbr.nodeName)){abbr=editor._getFirstAncestor(selection,['acronym','abbr']);}
var type=!Ext.isEmpty(abbr)?abbr.nodeName.toLowerCase():'';this.params={abbr:abbr,title:!Ext.isEmpty(abbr)?abbr.title:'',text:!Ext.isEmpty(abbr)?abbr.innerHTML:this.editor.getSelectedHTML()};this.openDialogue(this.getButton(buttonId).tooltip.title,buttonId,this.getWindowDimensions({width:580},buttonId),this.buildTabItemsConfig(abbr),this.buildButtonsConfig(abbr,this.okHandler,this.deleteHandler),(type=='acronym')?1:0);return false;},openDialogue:function(title,buttonId,dimensions,tabItems,buttonsConfig,activeTab){this.dialog=new Ext.Window({title:this.getHelpTip('',title),cls:'htmlarea-window',resizable:!Ext.isIE,border:false,width:dimensions.width,height:'auto',iconCls:this.getButton(buttonId).iconCls,listeners:{close:{fn:this.onClose,scope:this}},items:{xtype:'tabpanel',activeTab:activeTab?activeTab:0,defaults:{xtype:'container',layout:'form',defaults:{labelWidth:150}},listeners:{tabchange:{fn:this.syncHeight,scope:this}},items:tabItems},buttons:buttonsConfig});this.show();},buildTabItemsConfig:function(element){var type=!Ext.isEmpty(element)?element.nodeName.toLowerCase():'';var tabItems=[];var abbrTabItems=[];if(type!=='acronym'){if(!this.pageTSConfiguration.noAbbr){this.addConfigElement(this.buildDefinedTermFieldsetConfig((type=='abbr')?element:null,'abbr'),abbrTabItems);}
this.addConfigElement(this.buildUseTermFieldsetConfig((type=='abbr')?element:null,'abbr'),abbrTabItems);}
if(!Ext.isEmpty(abbrTabItems)){tabItems.push({title:this.localize('Abbreviation'),itemId:'abbr',items:abbrTabItems});}
var acronymTabItems=[];if(type!=='abbr'){if(!this.pageTSConfiguration.noAcronym){this.addConfigElement(this.buildDefinedTermFieldsetConfig((type=='acronym')?element:null,'acronym'),acronymTabItems);}
this.addConfigElement(this.buildUseTermFieldsetConfig((type=='abbr')?element:null,'abbr'),acronymTabItems);}
if(!Ext.isEmpty(acronymTabItems)){tabItems.push({title:this.localize('Acronym'),itemId:'acronym',items:acronymTabItems});}
return tabItems;},buildButtonsConfig:function(element,okHandler,deleteHandler){var buttonsConfig=[this.buildButtonConfig('OK',okHandler)];if(element){buttonsConfig.push(this.buildButtonConfig('Delete',deleteHandler));}
buttonsConfig.push(this.buildButtonConfig('Cancel',this.onCancel));return buttonsConfig;},buildDefinedTermFieldsetConfig:function(element,type){var itemsConfig=[];itemsConfig.push(Ext.apply({xtype:'combo',displayField:'term',valueField:'term',fieldLabel:this.getHelpTip('unabridgedTerm','Unabridged_term'),itemId:'termSelector',tpl:'<tpl for="."><div ext:qtip="{abbr}" style="text-align:left;font-size:11px;" class="x-combo-list-item">{term}</div></tpl>',store:new Ext.data.JsonStore({autoDestroy:true,autoLoad:true,root:type,fields:[{name:'term'},{name:'abbr'},{name:'language'}],url:this.pageTSConfiguration.acronymUrl}),width:350,listeners:{beforerender:{fn:function(combo){combo.getStore().load({callback:function(){this.onSelectorRender(combo);},scope:this});},scope:this},select:{fn:this.onTermSelect,scope:this}}},this.configDefaults['combo']));itemsConfig.push(Ext.apply({xtype:'combo',displayField:'abbr',valueField:'abbr',tpl:'<tpl for="."><div ext:qtip="{language}" style="text-align:left;font-size:11px;" class="x-combo-list-item">{abbr}</div></tpl>',fieldLabel:this.getHelpTip('abridgedTerm','Abridged_term'),itemId:'abbrSelector',store:new Ext.data.JsonStore({autoDestroy:true,autoLoad:true,root:type,fields:[{name:'term'},{name:'abbr'},{name:'language'}],url:this.pageTSConfiguration.acronymUrl}),width:100,listeners:{beforerender:{fn:function(combo){combo.getStore().load({callback:function(){this.onSelectorRender(combo);},scope:this});},scope:this},select:{fn:this.onAbbrSelect,scope:this}}},this.configDefaults['combo']));var languageObject=this.getPluginInstance('Language');if(this.getButton('Language')){var selectedLanguage=!Ext.isEmpty(element)?languageObject.getLanguageAttribute(element):'none';function initLanguageStore(store){if(selectedLanguage!=='none'){store.removeAt(0);store.insert(0,new store.recordType({text:languageObject.localize('Remove language mark'),value:'none'}));}
this.getButton('Language').setValue('none');}
var languageStore=new Ext.data.JsonStore({autoDestroy:true,autoLoad:true,root:'options',fields:[{name:'text'},{name:'value'}],url:this.getDropDownConfiguration('Language').dataUrl,listeners:{load:{fn:initLanguageStore,scope:this}}});itemsConfig.push(Ext.apply({xtype:'combo',fieldLabel:this.getHelpTip('language','Language'),itemId:'language',valueField:'value',displayField:'text',tpl:'<tpl for="."><div ext:qtip="{value}" style="text-align:left;font-size:11px;" class="x-combo-list-item">{text}</div></tpl>',store:languageStore,width:200,value:selectedLanguage,listeners:{render:{fn:function(combo){combo.getStore().load({callback:function(){combo.setValue(selectedLanguage);}});}}}},this.configDefaults['combo']));}
return{xtype:'fieldset',title:this.getHelpTip('preDefined'+((type=='abbr')?'Abbreviation':'Acronym'),'Defined_'+type),items:itemsConfig,listeners:{render:{fn:this.onDefinedTermFieldsetRender,scope:this}}};},onDefinedTermFieldsetRender:function(fieldset){var termSelector=fieldset.find('itemId','termSelector')[0];var term=termSelector.getValue();var abbrSelector=fieldset.find('itemId','abbrSelector')[0];var abbr=abbrSelector.getValue();var language='';var languageSelector=fieldset.find('itemId','language')[0];if(languageSelector){var language=languageSelector.getValue();if(language=='none'){language='';}}
if(abbr&&!term){var abbrStore=abbrSelector.getStore();var index=abbrStore.findBy(function(record){return record.get('abbr')==abbr&&(!languageSelector||record.get('language')==language);},this);if(index!==-1){term=abbrStore.getAt(index).get('term');termSelector.setValue(term);fieldset.ownerCt.find('itemId','useTerm')[0].setValue(term);}}},onSelectorRender:function(combo){var store=combo.getStore();store.filterBy(function(record){return!this.params.text||!this.params.title||this.params.text==record.get('term')||this.params.title==record.get('term')||this.params.title==record.get('abbr');},this);store.snapshot=store.data;var store=combo.getStore();if(combo.getItemId()=='termSelector'){if(this.params.title){var index=store.findExact('term',this.params.title);if(index!==-1){var record=store.getAt(index);combo.setValue(record.get('term'));this.onTermSelect(combo,record,index);}}else if(this.params.text){var index=store.findExact('term',this.params.text);if(index!==-1){var record=store.getAt(index);combo.setValue(record.get('term'));this.onTermSelect(combo,record,index);}}}else if(combo.getItemId()=='abbrSelector'&&this.params.text){var index=store.findExact('abbr',this.params.text);if(index!==-1){var record=store.getAt(index);combo.setValue(record.get('abbr'));this.onAbbrSelect(combo,record,index);}}},onTermSelect:function(combo,record,index){var fieldset=combo.findParentByType('fieldset');var tab=fieldset.findParentByType('container');var term=record.get('term');var abbr=record.get('abbr');var language=record.get('language');var abbrSelector=tab.find('itemId','abbrSelector')[0];abbrSelector.setValue(abbr);var languageSelector=tab.find('itemId','language');if(!Ext.isEmpty(languageSelector)){if(language){languageSelector[0].setValue(language);}else{languageSelector[0].setValue('none');}}
tab.find('itemId','useTerm')[0].setValue(term);},onAbbrSelect:function(combo,record,index){var fieldset=combo.findParentByType('fieldset');var tab=fieldset.findParentByType('container');var term=record.get('term');var language=record.get('language');var termSelector=tab.find('itemId','termSelector')[0];termSelector.setValue(term);var languageSelector=tab.find('itemId','language');if(!Ext.isEmpty(languageSelector)){if(language){languageSelector[0].setValue(language);}else{languageSelector[0].setValue('none');}}
tab.find('itemId','useTerm')[0].setValue(term);},buildUseTermFieldsetConfig:function(element,type){var itemsConfig=[];itemsConfig.push({fieldLabel:this.getHelpTip('useThisTerm','Use_this_term'),labelSeparator:'',itemId:'useTerm',value:element?element.title:'',width:300});return{xtype:'fieldset',title:this.getHelpTip('termToAbridge','Term_to_abridge'),defaultType:'textfield',items:itemsConfig};},okHandler:function(button,event){this.restoreSelection();var tab=this.dialog.findByType('tabpanel')[0].getActiveTab();var type=tab.getItemId();var languageSelector=tab.find('itemId','language');var language=!Ext.isEmpty(languageSelector)?languageSelector[0].getValue():'';var term=tab.find('itemId','termSelector')[0].getValue();if(!this.params.abbr){var abbr=this.editor.document.createElement(type);abbr.title=tab.find('itemId','useTerm')[0].getValue();if(term==abbr.title){abbr.innerHTML=tab.find('itemId','abbrSelector')[0].getValue();}else{abbr.innerHTML=this.params.text;}
if(language){this.getPluginInstance('Language').setLanguageAttributes(abbr,language);}
this.editor.insertNodeAtSelection(abbr);}else{var abbr=this.params.abbr;abbr.title=tab.find('itemId','useTerm')[0].getValue();if(language){this.getPluginInstance('Language').setLanguageAttributes(abbr,language);}
if(term==abbr.title){abbr.innerHTML=tab.find('itemId','abbrSelector')[0].getValue();}}
this.close();event.stopEvent();},deleteHandler:function(button,event){this.restoreSelection();var abbr=this.params.abbr;if(abbr){this.editor.removeMarkup(abbr);}
this.close();event.stopEvent();},onUpdateToolbar:function(button,mode,selectionEmpty,ancestors){if((mode==='wysiwyg')&&this.editor.isEditable()){var el=this.editor.getParentElement();if(el){button.setDisabled(((el.nodeName.toLowerCase()=='acronym'&&this.pageTSConfiguration.noAcronym)||(el.nodeName.toLowerCase()=='abbr'&&this.pageTSConfiguration.noAbbr)));button.setInactive(!(el.nodeName.toLowerCase()=='acronym'&&!this.pageTSConfiguration.noAcronym)&&!(el.nodeName.toLowerCase()=='abbr'&&!this.pageTSConfiguration.noAbbr));}
button.setTooltip({title:this.localize((button.disabled||button.inactive)?'Insert abbreviation':'Edit abbreviation')});button.contextMenuTitle='';if(this.dialog){this.dialog.focus();}}}});